% --------------------------------------------------------------------------
% the CARBOHYDRATES package
% 
%   ready drawn carbohadrates with chemfig
%
% --------------------------------------------------------------------------
% Clemens Niederberger
% Web:    https://github.com/cgnieder/carbohydrates
% E-Mail: contact@mychemistry.eu
% --------------------------------------------------------------------------
% Copyright 2014 Clemens Niederberger
% 
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
% 
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Clemens Niederberger.
% --------------------------------------------------------------------------
% If you have any ideas, questions, suggestions or bugs to report, please
% feel free to contact me.
% --------------------------------------------------------------------------
\def\cbhdr@date{2014/01/23}
\def\cbhdr@version{v0.0}
\def\cbhdr@info{carbohydrate molecules with chemfig}

\ProvidesPackage{carbohydrates}[%
  \cbhdr@date\space
  \cbhdr@version\space
  \cbhdr@info\space (CN)]

\RequirePackage{cnltx-base}
\RequirePackage{chemfig,xcolor}

% --------------------------------------------------------------------------
% message handling
% generic help message:
\def\cbhdr@error@message{%
  For details have a look at the `carbohydrates' manual.%
}

% create message macros:
\cnltx@create@generic@message{cbhdr}{carbohydrates}{Error}{\cbhdr@error@message}
\cnltx@create@generic@message{cbhdr}{carbohydrates}{Warning}{}
\cnltx@create@generic@message{cbhdr}{carbohydrates}{WarningNoLine}{}
\cnltx@create@generic@message{cbhdr}{carbohydrates}{Info}{}

% --------------------------------------------------------------------------
% colors
\colorlet{cbhdr@anomerO}{black}
\colorlet{cbhdr@anomerH}{black}
\colorlet{cbhdr@ringO}{black}

\newcommand*\cbhdr@atom@color[2]{\unexpanded{\textcolor{#1}{#2}}}

% --------------------------------------------------------------------------
% wavy bonds:
\usetikzlibrary{decorations.pathmorphing}
\pgfdeclaredecoration{cbhdr complete sines}{initial}{
  \state{initial}[
    width=+0pt,
    next state=sine,
    persistent precomputation={
      \pgfmathsetmacro\matchinglength{
        \pgfdecoratedinputsegmentlength /
        int(\pgfdecoratedinputsegmentlength/\pgfdecorationsegmentlength)
      }
      \setlength{\pgfdecorationsegmentlength}{\matchinglength pt}
    }
  ]{}
  \state{sine}[width=\pgfdecorationsegmentlength]{
    \pgfpathsine{
      \pgfpoint
        {0.25\pgfdecorationsegmentlength}
        {0.5\pgfdecorationsegmentamplitude}
    }
    \pgfpathcosine{
      \pgfpoint
        {0.25\pgfdecorationsegmentlength}
        {-0.5\pgfdecorationsegmentamplitude}
    }
    \pgfpathsine{
      \pgfpoint
        {0.25\pgfdecorationsegmentlength}
        {-0.5\pgfdecorationsegmentamplitude}
    }
    \pgfpathcosine{
      \pgfpoint
        {0.25\pgfdecorationsegmentlength}
        {0.5\pgfdecorationsegmentamplitude}
    }
  }
  \state{final}{}
}


\tikzset{
  cbhdr/wavy bond/.style =
    {
      decorate,
      decoration =
        {
          cbhdr complete sines,
          amplitude   = 0.23em ,
          post length = 0 pt,
          pre length  = 0 pt,
          % Use the atom spacing: saved 
          segment length = 
            \the\dimexpr\csname CF@atom@sep\endcsname/5\relax
        }
    }
}

% --------------------------------------------------------------------------
%% Fischer projections:
\newcommand*\cbhdr@OH[1]{%
  \cbhdr@atom@color{cbhdr@O-C#1}{O}|%
  \cbhdr@atom@color{cbhdr@H-C#1}{H}%
}
\newcommand*\cbhdr@HO[1]{%
  \cbhdr@atom@color{cbhdr@H-C#1}{H}|%
  \cbhdr@atom@color{cbhdr@O-C#1}{O}%
}
\newcommand*\cbhdr@ring@O{\cbhdr@atom@color{cbhdr@ringO}{O}}
\newcommand*\cbhdr@anomer@O{\cbhdr@atom@color{cbhdr@anomerO}{O}}
\newcommand*\cbhdr@anomer@OH{%
  \cbhdr@atom@color{cbhdr@anomerO}{O}|%
  \cbhdr@atom@color{cbhdr@anomerH}{H}%
}
\newcommand*\cbhdr@anomer@HO{%
  \cbhdr@atom@color{cbhdr@anomerH}{H}|%
  \cbhdr@atom@color{cbhdr@anomerO}{O}%
}

\newrobustcmd*\cbhdr@definesubmol@x{\cnltx@expandargs(nx)\definesubmol}
\newrobustcmd*\cbhdr@chemfig@x{\cnltx@expandargs(x)\chemfig}

\newrobustcmd\cbhdr@define@Csubmols[1]{%
  \colorlet{cbhdr@O-C#1}{black}%
  \colorlet{cbhdr@H-C#1}{black}%
  \colorlet{cbhdr@C#1}{black}%
  % aldohexoses:
  % fischer:
  % skeletons
  \cbhdr@definesubmol@x{cbhdr@OHr@fischer@skeleton@C#1}{(-[:0]\cbhdr@OH{#1})}%
  \cbhdr@definesubmol@x{cbhdr@OHl@fischer@skeleton@C#1}{(-[:180]\cbhdr@HO{#1})}%
  \cbhdr@definesubmol@x{cbhdr@OH0@fischer@skeleton@C#1}{}%
  % with C and H
  \cbhdr@definesubmol@x{cbhdr@OHr@fischer@C#1}{(-[:0]\cbhdr@OH{#1})(-[:180]H)}%
  \cbhdr@definesubmol@x{cbhdr@OHl@fischer@C#1}{(-[:180]\cbhdr@HO{#1})(-[:0]H)}%
  \cbhdr@definesubmol@x{cbhdr@OH0@fischer@C#1}{(-[:180]H)(-[:0]H)}%
  % haworth:
  \ifnum#1=5\relax
    \cbhdr@definesubmol@x{cbhdr@OHr@haworth@C#1}{(-[:0]\cbhdr@OH{#1})}%
    \cbhdr@definesubmol@x{cbhdr@OHl@haworth@C#1}{(-[:180,.5]\cbhdr@HO{#1})}%
  \else
    \cbhdr@definesubmol@x{cbhdr@OHr@haworth@C#1}{(-[:-90,.5,,1]\cbhdr@OH{#1})}%
    \cbhdr@definesubmol@x{cbhdr@OHl@haworth@C#1}{(-[:90,.5,,1]\cbhdr@OH{#1})}%
  \fi
  \definesubmol{cbhdr@OH0@haworth@C#1}{}%
  % chair:
  \ifcase#1
  \or % 1
  \or % 2
    \cbhdr@definesubmol@x{cbhdr@OHr@chair@C#1}{(-[:-55,.5,,1]\cbhdr@OH{#1})}%
    \cbhdr@definesubmol@x{cbhdr@OHl@chair@C#1}{(-[:90,.5,,1]\cbhdr@OH{#1})}%
  \or % 3
    \cbhdr@definesubmol@x{cbhdr@OHr@chair@C#1}{(-[:-90,.5,,1]\cbhdr@OH{#1})}%
    \cbhdr@definesubmol@x{cbhdr@OHl@chair@C#1}{(-[:170,.5,,2]\cbhdr@HO{#1})}%
  \or % 4
    \cbhdr@definesubmol@x{cbhdr@OHr@chair@C#1}{(-[:190,.5,,2]\cbhdr@HO{#1})}%
    \cbhdr@definesubmol@x{cbhdr@OHl@chair@C#1}{(-[:90,.5,,1]\cbhdr@OH{#1})}%
  \or % 5
    \cbhdr@definesubmol@x{cbhdr@OHr@chair@C#1}{(-[:10,,,1]\cbhdr@OH{#1})}%
    \cbhdr@definesubmol@x{cbhdr@OHl@chair@C#1}{(-[:-90,.5,,1]\cbhdr@OH{#1})}%
  \fi
  \definesubmol{cbhdr@OH0@chair@C#1}{}%
}
\cbhdr@define@Csubmols{2}
\cbhdr@define@Csubmols{3}
\cbhdr@define@Csubmols{4}
\cbhdr@define@Csubmols{5}

% fischer
\cbhdr@definesubmol@x{cbhdr@aldehyde@fischer@skeleton}{(=_[:30]\cbhdr@anomer@O)}
\cbhdr@definesubmol@x{cbhdr@OHalpha@fischer@skeleton}{(-[:0]\cbhdr@anomer@OH)}
\cbhdr@definesubmol@x{cbhdr@OHbeta@fischer@skeleton}{(-[:180]\cbhdr@anomer@HO)}
\cbhdr@definesubmol@x{cbhdr@OHundecided@fischer@skeleton}{(-[:0]\cbhdr@anomer@OH)}

\cbhdr@definesubmol@x{cbhdr@aldehyde@fischer}{(=_[:30]\cbhdr@anomer@O)(-[:150]H)}
\cbhdr@definesubmol@x{cbhdr@OHalpha@fischer}{(-[:0]\cbhdr@anomer@OH)(-[:180]H)}
\cbhdr@definesubmol@x{cbhdr@OHbeta@fischer}{(-[:180]\cbhdr@anomer@HO)(-[:0]H)}
\cbhdr@definesubmol@x{cbhdr@OHundecided@fischer}{(-[:0]\cbhdr@anomer@HO)(-[:180]H)}

% haworth
\cbhdr@definesubmol@x{cbhdr@OHalpha@haworth}{(-[:-90,.5,,1]\cbhdr@anomer@OH)}
\cbhdr@definesubmol@x{cbhdr@OHbeta@haworth}{(-[:90,.5,,1]\cbhdr@anomer@OH)}
\cbhdr@definesubmol@x{cbhdr@OHundetermined@haworth}
  {(-[:0,.75,,1,cbhdr/wavy bond]\cbhdr@anomer@OH)}

% chair:
\cbhdr@definesubmol@x{cbhdr@OHalpha@chair}{(-[:-90,.5,,1]\cbhdr@anomer@OH)}
\cbhdr@definesubmol@x{cbhdr@OHbeta@chair}{(-[:10,.5,,1]\cbhdr@anomer@OH)}
\cbhdr@definesubmol@x{cbhdr@OHundetermined@chair}
  {(-[:0,.75,,1,cbhdr/wavy bond]\cbhdr@anomer@OH)}

% naming scheme:
% <module>@<model>@<chain>/<ring>(@<ringtype>)

% --------------------------------------------------------------------------
% fischer
% skeleton fomulae:
\protected\def\cbhdr@aldohexose@fischer@skeleton@chain@aux#1#2#3#4\q@stop{%
  \cbhdr@chemfig@x{
    !{cbhdr@aldehyde@fischer@skeleton}
    -[:-90]!{cbhdr@OH#1@fischer@skeleton@C2}
    -[:-90]!{cbhdr@OH#2@fischer@skeleton@C3}
    -[:-90]!{cbhdr@OH#3@fischer@skeleton@C4}
    -[:-90]!{cbhdr@OH#4@fischer@skeleton@C5}
    -[:-90](-[:0]OH)
  }%
}
\newrobustcmd*\cbhdr@aldohexose@fischer@skeleton@chain[1]{%
  \cbhdr@aldohexose@fischer@skeleton@chain@aux#1\q@stop
}

\protected\def\cbhdr@aldohexose@fischer@skeleton@ring@pyranose@aux#1#2#3#4#5\q@stop{%
  \cbhdr@chemfig@x{
    !{cbhdr@OH#1@fischer@skeleton}(-[:90]-[:0]-?)
    -[:-90]!{cbhdr@OH#2@fischer@skeleton@C2}
    -[:-90]!{cbhdr@OH#3@fischer@skeleton@C3}
    -[:-90]!{cbhdr@OH#4@fischer@skeleton@C4}
    -[:-90](-[:0]\cbhdr@ring@O-?)
    -[:-90](-[:0]OH)
  }%
}
\newrobustcmd*\cbhdr@aldohexose@fischer@skeleton@ring@pyranose[1]{%
  \cbhdr@aldohexose@fischer@skeleton@ring@pyranose@aux{\cbhdr@anomer}#1\q@stop
}

% with C and H:
\protected\def\cbhdr@aldohexose@fischer@chain@aux#1#2#3#4\q@stop{%
  \cbhdr@chemfig@x{
    C!{cbhdr@aldehyde@fischer}
    -[:-90]C!{cbhdr@OH#1@fischer@C2}
    -[:-90]C!{cbhdr@OH#2@fischer@C3}
    -[:-90]C!{cbhdr@OH#3@fischer@C4}
    -[:-90]C!{cbhdr@OH#4@fischer@C5}
    -[:-90]C(-[:0]OH)(-[:180]H)
    -[:-90]H
  }%
}
\newrobustcmd*\cbhdr@aldohexose@fischer@chain[1]{%
  \cbhdr@aldohexose@fischer@chain@aux#1\q@stop
}

\protected\def\cbhdr@aldohexose@fischer@ring@pyranose@aux#1#2#3#4#5\q@stop{%
  \cbhdr@chemfig@x{
    C!{cbhdr@OH#1@fischer}(-[:90]-[:0]-?)
    -[:-90]C!{cbhdr@OH#2@fischer@C2}
    -[:-90]C!{cbhdr@OH#3@fischer@C3}
    -[:-90]C!{cbhdr@OH#4@fischer@C4}
    -[:-90]C(-[:0]\cbhdr@ring@O-?)(-[:180]H)
    -[:-90]C(-[:0]OH)(-[:180]H)
    -[:-90]H
  }%
}
\newrobustcmd*\cbhdr@aldohexose@fischer@ring@pyranose[1]{%
  \cbhdr@aldohexose@fischer@ring@pyranose@aux{\cbhdr@anomer}#1\q@stop
}

% --------------------------------------------------------------------------
% Haworth
\newcommand*\cbhdr@decr{-} % >
\newcommand*\cbhdr@thick{} % line width=3pt
\newcommand*\cbhdr@incr{-} % <

\protected\def\cbhdr@aldohexose@haworth@chain@aux#1#2#3#4\q@stop{%
  \cbhdr@chemfig@x{
    -[:30]
    ?(-[:90,.5]-[:150,.5]HO)!{cbhdr@OH#4@haworth@C5}-[,,,,draw=none]
    -[:-30,,1,,draw=none](=_[:0]\cbhdr@anomer@O)
    \cbhdr@incr[:-150]!{cbhdr@OH#1@haworth@C2}
    -[:-180,,,,\cbhdr@thick]!{cbhdr@OH#2@haworth@C3}
    \cbhdr@decr[:150]?!{cbhdr@OH#3@haworth@C4}
  }%
}
\newrobustcmd*\cbhdr@aldohexose@haworth@chain[1]{%
  \cbhdr@aldohexose@haworth@chain@aux#1\q@stop
}

\protected\def\cbhdr@aldohexose@haworth@ring@pyranose@aux#1#2#3#4#5\q@stop{%
  \cbhdr@chemfig@x{
    -[:30]
    ?(-[:90,.5]-[:150,.5]HO)-\cbhdr@ring@O
    -[:-30]!{cbhdr@OH#1@haworth}
    \cbhdr@incr[:-150]!{cbhdr@OH#2@haworth@C2}
    -[:-180,,,,\cbhdr@thick]!{cbhdr@OH#3@haworth@C3}
    \cbhdr@decr[:150]?!{cbhdr@OH#4@haworth@C4}
  }%
}

\newrobustcmd*\cbhdr@aldohexose@haworth@ring@pyranose[1]{%
  \cbhdr@aldohexose@haworth@ring@pyranose@aux{\cbhdr@anomer}#1\q@stop
}

% --------------------------------------------------------------------------
% chair:
\protected\def\cbhdr@aldohexose@chair@chain@aux#1#2#3#4\q@stop{%
  \cbhdr@chemfig@x{
    -[:-10]
    ?(-[:150,.5]-[:90,.5,,1]OH)!{cbhdr@OH#4@chair@C5}-[:10,,,,draw=none]
    -[:-50,,1,,draw=none](=_[:70]\cbhdr@anomer@O)
    \cbhdr@incr[:-170]!{cbhdr@OH#1@chair@C2}
    -[:-190,,,,\cbhdr@thick]!{cbhdr@OH#2@chair@C3}
    \cbhdr@decr[:130]?!{cbhdr@OH#3@chair@C4}
  }%
}
\newrobustcmd*\cbhdr@aldohexose@chair@chain[1]{%
  \cbhdr@aldohexose@chair@chain@aux#1\q@stop
}

\protected\def\cbhdr@aldohexose@chair@ring@pyranose@aux#1#2#3#4#5\q@stop{%
  \cbhdr@chemfig@x{
    -[:-10]
    ?(-[:150,.5]-[:90,.5,,1]OH)-[:10]\cbhdr@ring@O
    -[:-50]!{cbhdr@OH#1@chair}
    \cbhdr@incr[:170]!{cbhdr@OH#2@chair@C2}
    -[:190,,,,\cbhdr@thick]!{cbhdr@OH#3@chair@C3}
    \cbhdr@decr[:130]?!{cbhdr@OH#4@chair@C4}
  }%
}

\newrobustcmd*\cbhdr@aldohexose@chair@ring@pyranose[1]{%
  \cbhdr@aldohexose@chair@ring@pyranose@aux{\cbhdr@anomer}#1\q@stop
}

% --------------------------------------------------------------------------
% <module>@<model>@<chain>/<ring>(@<ringtype>)

\newcommand*\cbhdr@model{}    % fischer/haworth/chair
\newcommand*\cbhdr@fischer{}  % @skeleton
\newcommand*\cbhdr@form{}     % chain/ring
\newcommand*\cbhdr@chain{chain}
\newcommand*\cbhdr@ring{ring@\cbhdr@ringtype}
\newcommand*\cbhdr@ringtype{} % pyranose/furanose

\pgfkeys{
  cbhdr/.cd,
    model/.is choice ,
    model/fischer/.is choice ,
    model/fischer/skeleton/.code = \def\cbhdr@model{fischer@skeleton} ,
    model/fischer/full/.code = \def\cbhdr@model{fischer} ,
    model/fischer/.default = full ,
    model/haworth/.code = \def\cbhdr@model{haworth} ,
    model/chair/.code = \def\cbhdr@model{chair} ,
    chain/.code = \def\cbhdr@constitution{chain} ,
    ring/.is choice ,
    ring/true/.code = \def\cbhdr@constitution{ring@pyranose} ,
    ring/pyranose/.code = \def\cbhdr@constitution{ring@pyranose} ,
    ring/furanose/.code = \def\cbhdr@constitution{ring@furanose} ,
    ring/.default = true ,
    anomer/.is choice ,
    anomer/alpha/.code = \def\cbhdr@anomer{alpha} ,
    anomer/beta/.code = \def\cbhdr@anomer{beta} ,
    anomer/undetermined/.code = \def\cbhdr@anomer{undetermined} ,
    length/.is choice ,
    length/6/.code = \def\cbhdr@length{aldohexose} ,
    length/5/.code = \def\cbhdr@length{aldopentose} ,
    length/4/.code = \def\cbhdr@length{aldotetrose} ,
    length/3/.code = \def\cbhdr@length{aldotriose} ,
    defaults/.style = {
      model = fischer ,
      chain ,
      anomer = alpha ,
      length = 6
    }
}
\pgfqkeys{/cbhdr}{defaults}

\newrobustcmd*\carbohydrate[2][]{%
  \begingroup
    \pgfqkeys{/cbhdr}{defaults,#1}%
    \csuse{cbhdr@\cbhdr@length @\cbhdr@model @\cbhdr@constitution}{#2}%
  \endgroup
}

% --------------------------------------------------------------------------

\newrobustcmd*\newaldose[1]{%
  \@ifnextchar[ % ]
    {\cbhdr@newaldose{#1}}
    {\cbhdr@newaldose{#1}[]}%
}

\protected\def\cbhdr@newaldose#1[#2]#3{%
  \cnltx@expandargs(x)
  \pgfkeys{
    cbhdr/.cd,
      \cnltx@stripbs#1-defaults/.style={\unexpanded{#2}}
  }%
  \newrobustcmd*#1[1][]{%
    \expandafter\carbohydrate\expandafter[\cnltx@stripbs#1-defaults,##1]{#3}%
  }%
}

% --------------------------------------------------------------------------

% aldohexoses:
\newaldose \allose   [length=6]{rrrr}
\newaldose \altrose  [length=6]{lrrr}
\newaldose \glucose  [length=6]{rlrr}
\newaldose \mannose  [length=6]{llrr}
\newaldose \gulose   [length=6]{rrlr}
\newaldose \idose    [length=6]{lrlr}
\newaldose \galactose[length=6]{rllr}
\newaldose \talose   [length=6]{lllr}

% those are not implemented, yet, but if they will be...:

% aldopentoses:
\newaldose \ribose   [length=5]{rrr}
\newaldose \arabinose[length=5]{lrr}
\newaldose \xylose   [length=5]{rlr}
\newaldose \lyxose   [length=5]{llr}

\newaldose \desoxyribose[length=5]{0rr}

% aldotetroses:
\newaldose \erythrose[length=4]{rr}
\newaldose \threose  [length=4]{lr}

% aldotrioses:
\newaldose \glycerinaldehyde[length=3]{r}


% --------------------------------------------------------------------------

\endinput

% TODO:
- Ketten für Tri- Tetr- und Pentosen
- Furanose-Ringe für Hex- und Pentosen
- Fehlermeldungen
- Optionen für Farben

- Ketosen - viell. nur Fructose

