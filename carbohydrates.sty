% --------------------------------------------------------------------------
% the CARBOHYDRATES package
% 
%   ready drawn carbohadrates with chemfig
%
% --------------------------------------------------------------------------
% Clemens Niederberger
% Web:    https://github.com/cgnieder/carbohydrates
% E-Mail: contact@mychemistry.eu
% --------------------------------------------------------------------------
% Copyright 2014 Clemens Niederberger
% 
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
% 
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Clemens Niederberger.
% --------------------------------------------------------------------------
% If you have any ideas, questions, suggestions or bugs to report, please
% feel free to contact me.
% --------------------------------------------------------------------------
\def\cbhdr@date{2014/01/23}
\def\cbhdr@version{v0.0}
\def\cbhdr@info{carbohydrate molecules with chemfig}

\ProvidesPackage{carbohydrates}[%
  \cbhdr@date\space
  \cbhdr@version\space
  \cbhdr@info\space (CN)]

\RequirePackage{cnltx-base}
\RequirePackage{chemfig,xcolor}

% ==========================================================================
% message handling
% generic help message:
\def\cbhdr@error@message{%
  For details have a look at the `carbohydrates' manual.%
}

% create message macros:
\cnltx@create@generic@message{cbhdr}{carbohydrates}{Error}{\cbhdr@error@message}
\cnltx@create@generic@message{cbhdr}{carbohydrates}{Warning}{}
\cnltx@create@generic@message{cbhdr}{carbohydrates}{WarningNoLine}{}
\cnltx@create@generic@message{cbhdr}{carbohydrates}{Info}{}

% ==========================================================================
% colors
\colorlet{cbhdr@anomerO}{black}
\colorlet{cbhdr@anomerH}{black}
\colorlet{cbhdr@ringO}{black}

\newcommand*\cbhdr@atom@color[2]{\unexpanded{\textcolor{#1}{#2}}}

% ==========================================================================
% wavy bonds:
\usetikzlibrary{decorations.pathmorphing}
\pgfdeclaredecoration{cbhdr complete sines}{initial}{
  \state{initial}[
    width=+0pt,
    next state=sine,
    persistent precomputation={
      \pgfmathsetmacro\matchinglength{
        \pgfdecoratedinputsegmentlength /
        int(\pgfdecoratedinputsegmentlength/\pgfdecorationsegmentlength)
      }
      \setlength{\pgfdecorationsegmentlength}{\matchinglength pt}
    }
  ]{}
  \state{sine}[width=\pgfdecorationsegmentlength]{
    \pgfpathsine{
      \pgfpoint
        {0.25\pgfdecorationsegmentlength}
        {0.5\pgfdecorationsegmentamplitude}
    }
    \pgfpathcosine{
      \pgfpoint
        {0.25\pgfdecorationsegmentlength}
        {-0.5\pgfdecorationsegmentamplitude}
    }
    \pgfpathsine{
      \pgfpoint
        {0.25\pgfdecorationsegmentlength}
        {-0.5\pgfdecorationsegmentamplitude}
    }
    \pgfpathcosine{
      \pgfpoint
        {0.25\pgfdecorationsegmentlength}
        {0.5\pgfdecorationsegmentamplitude}
    }
  }
  \state{final}{}
}


\tikzset{
  cbhdr/wavy bond/.style =
    {
      decorate,
      decoration =
        {
          cbhdr complete sines,
          amplitude   = 0.23em ,
          post length = 0 pt,
          pre length  = 0 pt,
          % Use the atom spacing: saved 
          segment length = 
            \the\dimexpr\csname CF@atom@sep\endcsname/5\relax
        }
    }
}

% ==========================================================================
% sub molecules for all the modular building of the molecules later
\newcommand*\cbhdr@OH[1]{%
  \cbhdr@atom@color{cbhdr@O-C#1}{O}|%
  \cbhdr@atom@color{cbhdr@H-C#1}{H}%
}
\newcommand*\cbhdr@HO[1]{%
  \cbhdr@atom@color{cbhdr@H-C#1}{H}|%
  \cbhdr@atom@color{cbhdr@O-C#1}{O}%
}
\newcommand*\cbhdr@ring@O{\cbhdr@atom@color{cbhdr@ringO}{O}}
\newcommand*\cbhdr@anomer@O{\cbhdr@atom@color{cbhdr@anomerO}{O}}
\newcommand*\cbhdr@anomer@OH{%
  \cbhdr@atom@color{cbhdr@anomerO}{O}|%
  \cbhdr@atom@color{cbhdr@anomerH}{H}%
}
\newcommand*\cbhdr@anomer@HO{%
  \cbhdr@atom@color{cbhdr@anomerH}{H}|%
  \cbhdr@atom@color{cbhdr@anomerO}{O}%
}

\newrobustcmd*\cbhdr@definesubmol@x{\cnltx@expandargs(nx)\definesubmol}
\newrobustcmd*\cbhdr@chemfig@x{\cnltx@expandargs(x)\chemfig}

\newrobustcmd\cbhdr@define@Csubmols[1]{%
  \colorlet{cbhdr@O-C#1}{black}%
  \colorlet{cbhdr@H-C#1}{black}%
  \colorlet{cbhdr@C#1}{black}%
  % aldohexoses:
  % fischer:
  % skeletons
  \cbhdr@definesubmol@x{cbhdr@fischer@skeleton@C#1@OHr}{(-[:0]\cbhdr@OH{#1})}%
  \cbhdr@definesubmol@x{cbhdr@fischer@skeleton@C#1@OHl}{(-[:180]\cbhdr@HO{#1})}%
  \cbhdr@definesubmol@x{cbhdr@fischer@skeleton@C#1@OH0}{}%
  % with C and H
  \cbhdr@definesubmol@x{cbhdr@fischer@C#1@OHr}{(-[:0]\cbhdr@OH{#1})(-[:180]H)}%
  \cbhdr@definesubmol@x{cbhdr@fischer@C#1@OHl}{(-[:180]\cbhdr@HO{#1})(-[:0]H)}%
  \cbhdr@definesubmol@x{cbhdr@fischer@C#1@OH0}{(-[:180]H)(-[:0]H)}%
  % haworth:
  \ifnum#1=5\relax
    \cbhdr@definesubmol@x{cbhdr@haworth@C#1@OHr}{(-[:0]\cbhdr@OH{#1})}%
    \cbhdr@definesubmol@x{cbhdr@haworth@C#1@OHl}{(-[:180,.5]\cbhdr@HO{#1})}%
  \else
    \cbhdr@definesubmol@x{cbhdr@haworth@C#1@OHr}{(-[:-90,.5,,1]\cbhdr@OH{#1})}%
    \cbhdr@definesubmol@x{cbhdr@haworth@C#1@OHl}{(-[:90,.5,,1]\cbhdr@OH{#1})}%
  \fi
  \definesubmol{cbhdr@haworth@C#1@OH0}{}%
  % chair:
  \ifcase#1
  \or % 1
  \or % 2
    \cbhdr@definesubmol@x{cbhdr@chair@C#1@OHr}{(-[:-55,.5,,1]\cbhdr@OH{#1})}%
    \cbhdr@definesubmol@x{cbhdr@chair@C#1@OHl}{(-[:90,.5,,1]\cbhdr@OH{#1})}%
  \or % 3
    \cbhdr@definesubmol@x{cbhdr@chair@C#1@OHr}{(-[:-90,.5,,1]\cbhdr@OH{#1})}%
    \cbhdr@definesubmol@x{cbhdr@chair@C#1@OHl}{(-[:170,.5,,2]\cbhdr@HO{#1})}%
  \or % 4
    \cbhdr@definesubmol@x{cbhdr@chair@C#1@OHr}{(-[:190,.5,,2]\cbhdr@HO{#1})}%
    \cbhdr@definesubmol@x{cbhdr@chair@C#1@OHl}{(-[:90,.5,,1]\cbhdr@OH{#1})}%
  \or % 5
    \cbhdr@definesubmol@x{cbhdr@chair@C#1@OHr}{(-[:10,,,1]\cbhdr@OH{#1})}%
    \cbhdr@definesubmol@x{cbhdr@chair@C#1@OHl}{(-[:-90,.5,,1]\cbhdr@OH{#1})}%
  \fi
  \definesubmol{cbhdr@chair@C#1@OH0}{}%
}
\cbhdr@define@Csubmols{2}
\cbhdr@define@Csubmols{3}
\cbhdr@define@Csubmols{4}
\cbhdr@define@Csubmols{5}

\cbhdr@definesubmol@x{cbhdr@haworth@furanose@C2@OHr}{(-[:-90,.5]\cbhdr@OH{2})}
\cbhdr@definesubmol@x{cbhdr@haworth@furanose@C2@OHl}{(-[:90,.5,,2]\cbhdr@HO{2})}
\cbhdr@definesubmol@x{cbhdr@haworth@furanose@C3@OHr}{(-[:-90,.5]\cbhdr@OH{3})}
\cbhdr@definesubmol@x{cbhdr@haworth@furanose@C3@OHl}{(-[:90,.5]\cbhdr@OH{3})}
\cbhdr@definesubmol@x{cbhdr@haworth@furanose@C4@OHr@C5@OHr}{(
  -[:90,.5](<[:30,.5]\cbhdr@OH{5})
  -[:120,.5]
  -[:-180,.5]\cbhdr@HO{4}
)}
\cbhdr@definesubmol@x{cbhdr@haworth@furanose@C4@OHl@C5@OHr}{(
  -[:-90,.5](<:[:150,.5]\cbhdr@HO{5})
  -[:-120,.5]
  -[:180,.5]\cbhdr@HO{4}
)}
\cbhdr@definesubmol@x{cbhdr@haworth@furanose@C4@OHr@C5@OHl}{(
  -[:90,.5](<:[:30,.5]\cbhdr@OH{5})
  -[:120,.5]
  -[:-180,.5]\cbhdr@HO{4}
)}
\cbhdr@definesubmol@x{cbhdr@haworth@furanose@C4@OHl@C5@OHl}{(
  -[:-90,.5](<[:150,.5]\cbhdr@HO{5})
  -[:-120,.5]
  -[:180,.5]\cbhdr@HO{4}
)}

% fischer
\cbhdr@definesubmol@x{cbhdr@fischer@skeleton@aldehyde}{(=_[:30]\cbhdr@anomer@O)}
\cbhdr@definesubmol@x{cbhdr@fischer@skeleton@OHalpha}{(-[:0]\cbhdr@anomer@OH)}
\cbhdr@definesubmol@x{cbhdr@fischer@skeleton@OHbeta}{(-[:180]\cbhdr@anomer@HO)}
\cbhdr@definesubmol@x{cbhdr@fischer@skeleton@OHundetermined}{(-[:0]\cbhdr@anomer@OH)}

\cbhdr@definesubmol@x{cbhdr@fischer@aldehyde}{(=_[:30]\cbhdr@anomer@O)(-[:150]H)}
\cbhdr@definesubmol@x{cbhdr@fischer@OHalpha}{(-[:0]\cbhdr@anomer@OH)(-[:180]H)}
\cbhdr@definesubmol@x{cbhdr@fischer@OHbeta}{(-[:180]\cbhdr@anomer@HO)(-[:0]H)}
\cbhdr@definesubmol@x{cbhdr@fischer@OHundetermined}{(-[:0]\cbhdr@anomer@HO)(-[:180]H)}

% haworth
\cbhdr@definesubmol@x{cbhdr@haworth@OHalpha}{(-[:-90,.5,,1]\cbhdr@anomer@OH)}
\cbhdr@definesubmol@x{cbhdr@haworth@OHbeta}{(-[:90,.5,,1]\cbhdr@anomer@OH)}
\cbhdr@definesubmol@x{cbhdr@haworth@OHundetermined}
  {(-[:0,.75,,1,cbhdr/wavy bond]\cbhdr@anomer@OH)}

% chair:
\cbhdr@definesubmol@x{cbhdr@chair@OHalpha}{(-[:-90,.5,,1]\cbhdr@anomer@OH)}
\cbhdr@definesubmol@x{cbhdr@chair@OHbeta}{(-[:10,.5,,1]\cbhdr@anomer@OH)}
\cbhdr@definesubmol@x{cbhdr@chair@OHundetermined}
  {(-[:0,.75,,1,cbhdr/wavy bond]\cbhdr@anomer@OH)}

% ==========================================================================
% now let's build the molecules using the submolecules from above. They're
% all named using the following naming scheme:
%
% \<module>@<model>@<chain>/<ring>(@<ringtype>)
%
% --------------------------------------------------------------------------
% fischer
% hexoses
% skeleton fomulae
% chain
\protected\def\cbhdr@aldohexose@fischer@skeleton@chain@aux#1#2#3#4\q@stop{%
  \cbhdr@chemfig@x{
    !{cbhdr@fischer@skeleton@aldehyde}
    -[:-90]!{cbhdr@fischer@skeleton@C2@OH#1}
    -[:-90]!{cbhdr@fischer@skeleton@C3@OH#2}
    -[:-90]!{cbhdr@fischer@skeleton@C4@OH#3}
    -[:-90]!{cbhdr@fischer@skeleton@C5@OH#4}
    -[:-90](-[:0]OH)
  }%
}
\newrobustcmd*\cbhdr@aldohexose@fischer@skeleton@chain[1]{%
  \cbhdr@aldohexose@fischer@skeleton@chain@aux#1\q@stop
}

% pyranoses
\protected\def\cbhdr@aldohexose@fischer@skeleton@ring@pyranose@aux#1#2#3#4#5\q@stop{%
  \cbhdr@chemfig@x{
    !{cbhdr@fischer@skeleton@OH#1}(-[:90]-[:0]-?)
    -[:-90]!{cbhdr@fischer@skeleton@C2@OH#2}
    -[:-90]!{cbhdr@fischer@skeleton@C3@OH#3}
    -[:-90](-[:0]\cbhdr@ring@O-?)
    -[:-90]!{cbhdr@fischer@skeleton@C5@OH#5}
    -[:-90](-[:0]OH)
  }%
}
\newrobustcmd*\cbhdr@aldohexose@fischer@skeleton@ring@pyranose[1]{%
  \cbhdr@aldohexose@fischer@skeleton@ring@pyranose@aux{\cbhdr@anomer}#1\q@stop
}

% furanoses
\protected\def\cbhdr@aldohexose@fischer@skeleton@ring@furanose@aux#1#2#3#4#5\q@stop{%
  \cbhdr@chemfig@x{
    !{cbhdr@fischer@skeleton@OH#1}(-[:90]-[:0]-?)
    -[:-90]!{cbhdr@fischer@skeleton@C2@OH#2}
    -[:-90]!{cbhdr@fischer@skeleton@C3@OH#3}
    -[:-90]!{cbhdr@fischer@skeleton@C4@OH#4}
    -[:-90](-[:0]\cbhdr@ring@O-?)
    -[:-90](-[:0]OH)
  }%
}
\newrobustcmd*\cbhdr@aldohexose@fischer@skeleton@ring@furanose[1]{%
  \cbhdr@aldohexose@fischer@skeleton@ring@furanose@aux{\cbhdr@anomer}#1\q@stop
}

% pentoses
% chain
\protected\def\cbhdr@aldopentose@fischer@skeleton@chain@aux#1#2#3\q@stop{%
  \cbhdr@chemfig@x{
    !{cbhdr@fischer@skeleton@aldehyde}
    -[:-90]!{cbhdr@fischer@skeleton@C2@OH#1}
    -[:-90]!{cbhdr@fischer@skeleton@C3@OH#2}
    -[:-90]!{cbhdr@fischer@skeleton@C4@OH#3}
    -[:-90](-[:0]OH)
  }%
}
\newrobustcmd*\cbhdr@aldopentose@fischer@skeleton@chain[1]{%
  \cbhdr@aldohexose@fischer@skeleton@chain@aux#1\q@stop
}

% furanoses
\protected\def\cbhdr@aldopentose@fischer@skeleton@ring@furanose@aux#1#2#3#4\q@stop{%
  \cbhdr@chemfig@x{
    !{cbhdr@fischer@skeleton@OH#1}(-[:90]-[:0]-?)
    -[:-90]!{cbhdr@fischer@skeleton@C2@OH#2}
    -[:-90]!{cbhdr@fischer@skeleton@C3@OH#3}
    -[:-90](-[:0]\cbhdr@ring@O-?)
    -[:-90](-[:0]OH)
  }%
}
\newrobustcmd*\cbhdr@aldopentose@fischer@skeleton@ring@furanose[1]{%
  \cbhdr@aldopentose@fischer@skeleton@ring@furanose@aux{\cbhdr@anomer}#1\q@stop
}

% --------------------------------------------------------------------------
% with C and H
% hexoses
% chain
\protected\def\cbhdr@aldohexose@fischer@chain@aux#1#2#3#4\q@stop{%
  \cbhdr@chemfig@x{
    C!{cbhdr@fischer@aldehyde}
    -[:-90]C!{cbhdr@fischer@C2@OH#1}
    -[:-90]C!{cbhdr@fischer@C3@OH#2}
    -[:-90]C!{cbhdr@fischer@C4@OH#3}
    -[:-90]C!{cbhdr@fischer@C5@OH#4}
    -[:-90]C(-[:0]OH)(-[:180]H)
    -[:-90]H
  }%
}
\newrobustcmd*\cbhdr@aldohexose@fischer@chain[1]{%
  \cbhdr@aldohexose@fischer@chain@aux#1\q@stop
}

% pyranoses
\protected\def\cbhdr@aldohexose@fischer@ring@pyranose@aux#1#2#3#4#5\q@stop{%
  \cbhdr@chemfig@x{
    C!{cbhdr@fischer@OH#1}(-[:90]-[:0]-?)
    -[:-90]C!{cbhdr@fischer@C2@OH#2}
    -[:-90]C!{cbhdr@fischer@C3@OH#3}
    -[:-90]C!{cbhdr@fischer@C4@OH#4}
    -[:-90]C(-[:0]\cbhdr@ring@O-?)(-[:180]H)
    -[:-90]C(-[:0]OH)(-[:180]H)
    -[:-90]H
  }%
}
\newrobustcmd*\cbhdr@aldohexose@fischer@ring@pyranose[1]{%
  \cbhdr@aldohexose@fischer@ring@pyranose@aux{\cbhdr@anomer}#1\q@stop
}

% furanoses
\protected\def\cbhdr@aldohexose@fischer@ring@furanose@aux#1#2#3#4#5\q@stop{%
  \cbhdr@chemfig@x{
    C!{cbhdr@fischer@OH#1}(-[:90]-[:0]-?)
    -[:-90]C!{cbhdr@fischer@C2@OH#2}
    -[:-90]C!{cbhdr@fischer@C3@OH#3}
    -[:-90]C(-[:0]\cbhdr@ring@O-?)(-[:180]H)
    -[:-90]C!{cbhdr@fischer@C5@OH#5}
    -[:-90]C(-[:0]OH)(-[:180]H)
    -[:-90]H
  }%
}
\newrobustcmd*\cbhdr@aldohexose@fischer@ring@furanose[1]{%
  \cbhdr@aldohexose@fischer@ring@furanose@aux{\cbhdr@anomer}#1\q@stop
}

% pentoses
% chain
\protected\def\cbhdr@aldopentose@fischer@chain@aux#1#2#3\q@stop{%
  \cbhdr@chemfig@x{
    C!{cbhdr@fischer@aldehyde}
    -[:-90]C!{cbhdr@fischer@C2@OH#1}
    -[:-90]C!{cbhdr@fischer@C3@OH#2}
    -[:-90]C!{cbhdr@fischer@C4@OH#3}
    -[:-90]C(-[:0]OH)(-[:180]H)
    -[:-90]H
  }%
}
\newrobustcmd*\cbhdr@aldopentose@fischer@chain[1]{%
  \cbhdr@aldopentose@fischer@chain@aux#1\q@stop
}

% furanoses
\protected\def\cbhdr@aldopentose@fischer@ring@furanose@aux#1#2#3#4\q@stop{%
  \cbhdr@chemfig@x{
    C!{cbhdr@fischer@OH#1}(-[:90]-[:0]-?)
    -[:-90]C!{cbhdr@fischer@C2@OH#2}
    -[:-90]C!{cbhdr@fischer@C3@OH#3}
    -[:-90]C(-[:0]\cbhdr@ring@O-?)(-[:180]H)
    -[:-90]C(-[:0]OH)(-[:180]H)
    -[:-90]H
  }%
}
\newrobustcmd*\cbhdr@aldopentose@fischer@ring@furanose[1]{%
  \cbhdr@aldopentose@fischer@ring@furanose@aux{\cbhdr@anomer}#1\q@stop
}

% --------------------------------------------------------------------------
% Haworth
\newcommand*\cbhdr@decr{-} % >
\newcommand*\cbhdr@thick{} % line width=3pt
\newcommand*\cbhdr@incr{-} % <

% hexoses
% chain
\protected\def\cbhdr@aldohexose@haworth@chain@aux#1#2#3#4\q@stop{%
  \cbhdr@chemfig@x{
    -[:30]
    ?(-[:90,.5]-[:150,.5]HO)!{cbhdr@haworth@C5@OH#4}-[,,,,draw=none]
    -[:-30,,1,,draw=none](=_[:0]\cbhdr@anomer@O)
    \cbhdr@incr[:-150]!{cbhdr@haworth@C2@OH#1}
    -[:-180,,,,\cbhdr@thick]!{cbhdr@haworth@C3@OH#2}
    \cbhdr@decr[:150]?!{cbhdr@haworth@C4@OH#3}
  }%
}
\newrobustcmd*\cbhdr@aldohexose@haworth@chain[1]{%
  \cbhdr@aldohexose@haworth@chain@aux#1\q@stop
}

% pyranoses
\protected\def\cbhdr@aldohexose@haworth@ring@pyranose@aux#1#2#3#4#5\q@stop{%
  \cbhdr@chemfig@x{
    -[:30]
    ?(-[:90,.5]-[:150,.5]HO)-\cbhdr@ring@O
    -[:-30]!{cbhdr@haworth@OH#1}
    \cbhdr@incr[:-150]!{cbhdr@haworth@C2@OH#2}
    -[:-180,,,,\cbhdr@thick]!{cbhdr@haworth@C3@OH#3}
    \cbhdr@decr[:150]?!{cbhdr@haworth@C4@OH#4}
  }%
}

\newrobustcmd*\cbhdr@aldohexose@haworth@ring@pyranose[1]{%
  \cbhdr@aldohexose@haworth@ring@pyranose@aux{\cbhdr@anomer}#1\q@stop
}

% furanoses
\protected\def\cbhdr@aldohexose@haworth@ring@furanose@aux#1#2#3#4#5\q@stop{%
  \cbhdr@chemfig@x{
    \cbhdr@ring@O?-[:-20]!{cbhdr@haworth@OH#1}
    -[:-110]!{cbhdr@haworth@furanose@C2@OH#2}
    -[:180,1.1954]!{cbhdr@haworth@furanose@C3@OH#3}
    -[:110]?!{cbhdr@haworth@furanose@C4@OH#4@C5@OH#5}
  }%
}
\newrobustcmd*\cbhdr@aldohexose@haworth@ring@furanose[1]{%
  \cbhdr@aldohexose@haworth@ring@furanose@aux{\cbhdr@anomer}#1\q@stop
}

% pentoses
% chain
% furanoses

% --------------------------------------------------------------------------
% chair
% hexoses
% chain
\protected\def\cbhdr@aldohexose@chair@chain@aux#1#2#3#4\q@stop{%
  \cbhdr@chemfig@x{
    -[:-10]
    ?(-[:150,.5]-[:90,.5,,1]OH)!{cbhdr@chair@C5@OH#4}-[:10,,,,draw=none]
    -[:-50,,1,,draw=none](=_[:70]\cbhdr@anomer@O)
    \cbhdr@incr[:-170]!{cbhdr@chair@C2@OH#1}
    -[:-190,,,,\cbhdr@thick]!{cbhdr@chair@C3@OH#2}
    \cbhdr@decr[:130]?!{cbhdr@chair@C4@OH#3}
  }%
}
\newrobustcmd*\cbhdr@aldohexose@chair@chain[1]{%
  \cbhdr@aldohexose@chair@chain@aux#1\q@stop
}

% pyranoses
\protected\def\cbhdr@aldohexose@chair@ring@pyranose@aux#1#2#3#4#5\q@stop{%
  \cbhdr@chemfig@x{
    -[:-10]
    ?(-[:150,.5]-[:90,.5,,1]OH)-[:10]\cbhdr@ring@O
    -[:-50]!{cbhdr@chair@OH#1}
    \cbhdr@incr[:170]!{cbhdr@chair@C2@OH#2}
    -[:190,,,,\cbhdr@thick]!{cbhdr@chair@C3@OH#3}
    \cbhdr@decr[:130]?!{cbhdr@chair@C4@OH#4}
  }%
}

\newrobustcmd*\cbhdr@aldohexose@chair@ring@pyranose[1]{%
  \cbhdr@aldohexose@chair@ring@pyranose@aux{\cbhdr@anomer}#1\q@stop
}

% furanoses
% pentoses
% chain
% furanoses

% ==========================================================================
% the user commands - built from the commands above using the already
% mentioned naming scheme
%
% <module>@<model>@<chain>/<ring>(@<ringtype>)

\newcommand*\cbhdr@model{}    % fischer/haworth/chair
\newcommand*\cbhdr@fischer{}  % @skeleton
\newcommand*\cbhdr@form{}     % chain/ring
\newcommand*\cbhdr@chain{chain}
\newcommand*\cbhdr@ring{ring@\cbhdr@ringtype}
\newcommand*\cbhdr@ringtype{} % pyranose/furanose
\newcommand*\cbhdr@pyranose{pyranose}

% --------------------------------------------------------------------------
% options for the user command:
\pgfkeys{
  cbhdr/.cd,
    model/.is choice ,
    model/fischer/.is choice ,
    model/fischer/skeleton/.code = \def\cbhdr@model{fischer@skeleton} ,
    model/fischer/full/.code = \def\cbhdr@model{fischer} ,
    model/fischer/.default = full ,
    model/haworth/.code = \def\cbhdr@model{haworth} ,
    model/chair/.code = \def\cbhdr@model{chair} ,
    chain/.code = \def\cbhdr@constitution{chain} ,
    ring/.is choice ,
    ring/true/.code = \def\cbhdr@constitution{ring@\cbhdr@pyranose} ,
    ring/pyranose/.code = \def\cbhdr@constitution{ring@\cbhdr@pyranose} ,
    ring/furanose/.code = \def\cbhdr@constitution{ring@furanose} ,
    ring/.default = true ,
    anomer/.is choice ,
    anomer/alpha/.code = \def\cbhdr@anomer{alpha} ,
    anomer/beta/.code = \def\cbhdr@anomer{beta} ,
    anomer/undetermined/.code = \def\cbhdr@anomer{undetermined} ,
    length/.is choice ,
    length/6/.code =
      \def\cbhdr@pyranose{pyranose}
      \def\cbhdr@length{aldohexose} ,
    length/5/.code =
      \def\cbhdr@pyranose{furanose}
      \def\cbhdr@length{aldopentose} ,
    length/4/.code = \def\cbhdr@length{aldotetrose} ,
    length/3/.code = \def\cbhdr@length{aldotriose} ,
    defaults/.style = {
      model = fischer ,
      chain ,
      anomer = alpha ,
      length = 6
    }
}
\pgfqkeys{/cbhdr}{defaults}

% --------------------------------------------------------------------------
% the user command:
\newrobustcmd*\cbhdr@carbohydrate[2]{%
  \begingroup
    \pgfqkeys{/cbhdr}{defaults,#1}%
    \csuse{cbhdr@\cbhdr@length @\cbhdr@model @\cbhdr@constitution}{#2}%
  \endgroup
}

\newrobustcmd*\carbohydrate[2][]{\cbhdr@carbohydrate{#1}{#2}}

% ==========================================================================
% a command to define ready made carbohydrates

\newrobustcmd*\newaldose[1]{%
  \@ifnextchar[ % ]
    {\cbhdr@newaldose{#1}}
    {\cbhdr@newaldose{#1}[]}%
}

\protected\def\cbhdr@newaldose#1[#2]#3{%
  \cnltx@expandargs(x)
  \pgfkeys{
    cbhdr/.cd,
      \cnltx@stripbs#1-defaults/.style={\unexpanded{#2}}
  }%
  \newrobustcmd*#1[1][]{%
    \expandafter\carbohydrate\expandafter[\cnltx@stripbs#1-defaults,##1]{#3}%
  }%
}

% ==========================================================================
% predefined carbohydrates:
% aldohexoses:
\newaldose \allose   [length=6]{rrrr}
\newaldose \altrose  [length=6]{lrrr}
\newaldose \glucose  [length=6]{rlrr}
\newaldose \mannose  [length=6]{llrr}
\newaldose \gulose   [length=6]{rrlr}
\newaldose \idose    [length=6]{lrlr}
\newaldose \galactose[length=6]{rllr}
\newaldose \talose   [length=6]{lllr}

% for the time being those are only partially implemented:
% aldopentoses:
\newaldose \ribose   [length=5]{rrr}
\newaldose \arabinose[length=5]{lrr}
\newaldose \xylose   [length=5]{rlr}
\newaldose \lyxose   [length=5]{llr}

\newaldose \desoxyribose[length=5]{0rr}

% aldotetroses:
\newaldose \erythrose[length=4]{rr}
\newaldose \threose  [length=4]{lr}

% aldotrioses:
\newaldose \glycerinaldehyde[length=3]{r}

% ==========================================================================
% setup commands
% general defaults:
\newrobustcmd*\setcarbohydrate[1]{%
  \pgfkeys{
    cbhdr/.cd ,
      defaults/.style = { #1 } ,
      defaults
  }%
}

% defaults for particular carbohydrate defined with \newaldose:
\newrobustcmd*\setcarbohydratedefaults[2]{%
  \pgfkeys{
    cbhdr/.cd ,
      #1-defaults/.style = { #2 } ,
      #1-defaults
  }%
}

\endinput
% ==========================================================================
% HISTORY:

% ==========================================================================
% TODO:
- Ketten für Tri- Tetr- und Pentosen
- Furanose-Ringe für Hex- und Pentosen
- Fehlermeldungen
- Optionen für Farben

- Ketosen - viell. nur Fructose

